<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS 이벤트루프 시뮬레이션 도구</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        #container {
            display: flex;
        }

        .box {
            width: 200px;
            height: 300px;
            border: 1px solid #000;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .material-symbols-outlined.on {
            position: absolute;
            animation: rotate .3s linear;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>JS 이벤트루프 시뮬레이션 도구</h1>
        <div id="buttons">
            <button onclick="functionCall()">일반함수</button>
            <button onclick="functionCall(1)">Web API task(매크로 테스크 큐)</button>
            <button onclick="functionCall(2)">Web API task(마이크로 테스크 큐)</button>
        </div>
    </header>

    <div id="container">
        <div class="box">
            <button onclick="clearConsole()">초기화</button>
            <h3 class="box-title">console</h3>
            <div id="console" class="box-content"></div>
        </div>
        <div class="box">
            <h3 class="box-title">스택</h3>
            <div id="stack" class="box-content"></div>
        </div>
        <div class="box">
            <h3 class="box-title">webAPis</h3>
            <div id="webApis" class="box-content"></div>
        </div>
        <div class="box">
            <h3 class="box-title">이벤트 루프</h3>
            <div id="eventLoop" class="box-content">
                <span class="material-symbols-outlined">manage_history</span>
            </div>
        </div>
        <div class="box">
            <h3 class="box-title">매크로 큐</h3>
            <div id="macroQueue" class="box-content"></div>
        </div>
        <div class="box">
            <h3 class="box-title">마이크로 큐</h3>
            <div id="microQueue" class="box-content"></div>
        </div>
    </div>
</body>

<script>
    const contextNames = ['일반함수', '매크로 큐 동작함수', '마이크로 큐 동작 함수']
    const stackEl = document.querySelector('#stack');
    const consoleEl = document.querySelector('#console');
    const webApisEl = document.querySelector('#webApis');
    const eventLoopEl = document.querySelector('#eventLoop');
    const macroEl = document.querySelector('#macroQueue');
    const microEl = document.querySelector('#microQueue');
    const TIMER = 1000;

    function functionCall(buttonNumber = 0) {
        // 스택에 있는 작업을 콘솔로 이동시키는 함수
        const moveStackToConsole = () => {
            setTimeout(() => {
                consoleEl.appendChild(createEl)
            }, TIMER)
        }

        // 이벤트 루프 실행 함수
        const runEventLoop = () => {
            const loop = setInterval(() => {
                // 스택에 작업이 있거나 매크로 테스크 큥
                if (stackEl.hasChildNodes() || (buttonNumber == 1 && microEl.hasChildNodes())) return;
                clearInterval(loop)
                moveStackToConsole()
            }, 300)
        }

        // Web API 작업을 콜백 큐에 저장하고 이벤트 루프를 실행하는 함수
        const asyncFunction = () => {
            setTimeout(() => {
                webApisEl.appendChild(createEl)

                const iconEl = document.createElement('span');
                iconEl.classList.add('material-symbols-outlined');
                iconEl.innerText = 'history';
                iconEl.classList.add('on');
                createEl.appendChild(iconEl)

                setTimeout(() => {
                    createEl.removeChild(iconEl);
                    if (buttonNumber == 1) macroEl.appendChild(createEl)
                    if (buttonNumber == 2) microEl.appendChild(createEl)
                    setTimeout(() => {
                        runEventLoop()
                    }, TIMER)
                }, TIMER)
            }, TIMER)
        }

        // 작업 생성
        const name = contextNames[buttonNumber];
        const createEl = document.createElement('div');
        createEl.innerText = name;

        // 작업을 스택으로 이동
        stackEl.prepend(createEl)

        // Web API 작업일 경우
        if (buttonNumber != 0) {
            asyncFunction()
            return;
        }
        moveStackToConsole();
    }

    /* console 초기화 하는 함수*/
    function clearConsole() {
        document.querySelector('#console').innerHTML = '';
    }
</script>

</html>